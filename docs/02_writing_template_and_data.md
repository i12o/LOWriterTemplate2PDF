# テンプレート文書と差し込みデータの作り方

## 用語と、必要そうなWriterの説明

面倒なら次行って下さい。変な言葉出てきたと思ったら読みに戻って下さい。

### 差し込みデータに関する部分

差し込みに使うデータを、以後単に「データ」と呼びます。

データは、「レコード」の集合で、レコードは「データフィールド名」とそれ
に対する「値」の集合からなります。RDBテーブルや、表計算の単純な表で言
えば、「列名」が「データフィールド」で、各行が「レコード」になります。

レコードはキーバリューペア、連想配列、ハッシュ、ディクショナリ、なんで
も良いですが、そんなもんです。このプログラムのモジュールでは、python3
のdictionary 型に変換できるものであれば、なんでも受け付けます。スクリ
プトはタブ切りのCSVを読み込むように作っています。

実際にスクリプトに喰わせるデータを作る際、「データフィールド名」を「カ
ラム名」に書き換えます(元テーブルの列名がデータフィールド名、出力テー
ブルビューの列名がカラム名、とお考え下さい)。CSVにする時は、最初の行の
各列には、「カラム名」を列挙して下さい。

### Writer に関する部分

以降では日本語化された Writer のインターフェースで表示される名称をベー
スに説明を進めます。

Writerでテンプレート文書(以降、単に「 **テンプレート** 」と呼びます)を
作成する際、テキストを差し込む場所にはWriterで言う「フィールド」を使い
ます。Writerのフィールドを、「データフィールド」と区別のため、以後
「 **テキストフィールド** 」と呼びます。テキストフィールドは、メニュー
の「挿入」→「フィールド」→「その他のフィールド」で表示されるダイアロ
グから、文書に埋め込む事ができます。このダイアログは Ctrl+F2 で直接呼
び出せるみたいです。

テキストフィールドにはいろいろ種類がありますが、このシステムで差し込み
用に使用するのは、「フィールドタイプ」が「ユーザー欄」で、書式を「テキ
スト」としたものです。ユーザ欄タイプのテキストフィールドは、文書固有の
ユーザ定義変数のようなもので、好きな「名前」に「値」を割り当てられます。
このユーザ欄タイプのテキストフィールドを、以後「 **ユーザフィールド**
」と呼びます。ユーザフィールドを文書に埋め込むと、その「ユーザフィール
ド名」に対応する「ユーザフィールド値」が表示/印刷などされます。

文書そのものを書き換えなくても、ユーザフィールド値を変更すると、文書中
のユーザフィールドの表示が変化します。文書に埋め込まれたユーザフィール
ドは、一固まりの文字列なので、右寄せ左寄せ、フォント種、大きさ、色の変
更など適用できます。ただしユーザフィールド値の一部だけにスタイルを適用
する、といった事はできません。

Writer 文書に画像、表、枠などを埋め込むと、それぞれは一つのオブジェク
トとして存在します。「ナビゲーター」からは、文書に埋め込まれたオブジェ
クトをその種類毎に確認できます。これらのオブジェクトには「プロパティ」
があり、色々な情報(折り返しの方法、背景、外枠の種類など)が付随していま
す。

オブジェクトには「名前」があり、文書に挿入された際自動的に名前が付けら
れます(枠1、枠2、…、イメージ1、イメージ2…など)。オブジェクトは名前で
区別されるので、名前は一意にしなければなりません。このシステムでは、画
像の名前を積極的に利用します。以降、これを「 **画像名** 」と呼びます。
画像名は、画像を右クリックして選ぶ「プロパティダイアログ」で、「オプショ
ン」タブから確認、変更ができます。ナビゲータでは、一覧表示されている画
像名を右クリック、「イメージ」→「名前の変更」を選んで、直接変更もでき
るようです。

メニューから「挿入」→「フレーム」→「対話的に枠を挿入」あるいは「枠」
を選ぶと、文書中に「枠」を挿入できます。「枠」もオブジェクトです。枠に
は外枠を付けたり、中にテキストや他のオブジェクトを入れられ、これらの段
組や配置などを指定もできます。複雑なレイアウトの帳票を作成する際、多分
「枠」を多用する事になると思います。以後、「枠」は普通に枠と呼びます。

各オブジェクトは「アンカー」プロパティを使い、文書内の何を基準にして位
置決めを行なうか選択できます。レイアウトを調整する際、画像や枠を、「ペー
ジ」にアンカーさせて絶対的な位置で配置したり、他のベースとなる枠にアン
カーさせてベース枠の中での相対位置として配置できます。

枠や画像オブジェクトを配置する際、「折り返し」プロパティを適切なものに
しておかないと、オブジェクトの位置や大きさをちょっと変えただけで文書の
とんでもないところの配置が変わってしまう場合があります。レイアウト調整
には折り返しの設定、重要です。

縦横の枠にあわせてきっちり要素を配置するような場合、ページアンカー、折
り返しなし、で枠や画像を絶対位置で置いていくと、後々の調整がやりやすく
なります。

あとオブジェクトには「説明」というプロパティが付けられるものがあります。
特定の目的でシステムが利用する場合があります。

## 基本

テンプレートとデータは、データフィールド名で結び付きます。データのデー
タフィールド名に対する値が、テンプレートの関連するユーザフィールド名、
画像名のところに差し込まれます。

が、ただのテキスト差し込みではない、画像を切り替えたり作成したりする必
要がある部分では、データのデータフィールド名に対するカラム名を設定し、
テンプレートでは画像名を設定しなければなりません。

説明していきます。

## データ(CSV)の作成

元データはDBや表計算シート、別のCSVファイルなどにある事でしょう。そこ
からデータを取り出す方法は、自由にやって下さい。差し込みに使うデータ
(CSV)は、以下のルールで作成します。

 - 列区切りはTAB
 - 一行目の各列は、「カラム名」
 - 二行目以降の各列は、データフィールド値

そんだけです。改行は python の pandas を使っているので、unix形式(LF)、
DOS(CR+LF)、Mac(CR) どれでも大丈夫、なのかな。動作させるOSネイティブの
ものにしておけば問題ないでしょう。

カラム名は、データフィールド名を基準に付けます。

 - ただのテキスト埋め込み
 - バーコード、QRコード生成値に使う

だけのデータフィールドであれば、カラム名はデータフィールド名をそのまま
使います。

「.」と「,」はプログラム内部で特殊な意味を持つ記号として使われますので、
データフィールド名に「.」と「,」を含めないようにして下さい。

なお、ただの埋め込みに使うカラムの値は、そのままの形式でテンプレートに
差し込まれます。数字の三桁毎にカンマを入れる、といった処理は、すみませ
んがデータ生成の時点で行なって下さい。

### Toggle 用

画像切り替え(Toggleと呼びます)のために使うデータフィールドの場合、カラ
ム名は `データフィールド名.Toggle` とします。

画像切り替えというのは、データフィールドの値、0,1 や A、B、C… の値に
応じて、テンプレートの対応する画像を差し替えるものです。

    □ 以上に同意します

の□部分を、`agreement` データフィールドの値が 0 か 1 かによって×、○
の画像で切り替え表示するのが、画像切り替え(Toggleタイプ)です。×、○に
対応する画像を自分で用意しておけば、○×やマークシート風、チェックマー
クなどを使ったPDFを作成できます。

color データフィールドが赤、青、黒、白を取る場合で、

    色: 赤 ○
    (○のところを赤の画像に置き換える)

このようなPDFを作成したい場合、値をテキストとして埋め込む用のカラムと、
画像切り替えのために使う用のカラムを二つ用意しなければなりません。

 - `color`
 - `color.Toggle`

というカラム名の列をデータに含めて下さい。なお、Toggle なカラムの「値」
はファイル名の一部として参照されるので、ファイル名として問題のない文字
だけを使うのが無難です。データ作成時の処理の一部として、color.Toggleの
値は color の値から変換して作成するのも良いでしょう。ともかく、Toggle
な列の値は、OSのファイル名として問題のない文字だけを使うようにした方が
無難です。

### Selection 用

データフィールド値によって一連の画像に対する切り替えを行なう場合、カラ
ム名を `データフィールド名.Selection` とします。

例えば era データフィールドの値 M、T、S、H、R から

    □ 明治  □ 大正 □ 昭和 □ 平成 □ 令和

どれかの□にチェックを入れるような場合(ラジオボタン風動作)、Selection
が使えます。データのカラム名を `era.Selection`として、CSVにします。

内部的には Selction は一連の Toggle として分解実行されます。なので
`era_M.Toggle`、`era_T.Toggle`、`era_S.Toggle`…をデータとして用意して
も同じような事になります(テンプレートの該当個所の書き方は変わります)。

データフィールド値を、` `(スペース)、`,`(カンマ)で区切って、複数選択の
表現ができます。カラム名 `company.Selection`、値を`D,S`などとして

    ■ D社  □ A社 ■ S社 □ R社

のような出力にする事もできます。

Toggle 同様、データフィールド値をテキストとして直接埋め込む場所がある
場合直接埋め込み用の `company` カラムは別に用意して下さい。

切り替えられる画像としてどんなパターンの物を選択するかは、テンプレート
を作成する人が決定します。データ作成者は、差し込み処理に必要なデータ
フィールドとカラム名の設定に注意して、データ生成処理に注力して下さい。

### 印刷ページ制御カラム

複数ページからなるテンプレートを使い、データに`__meta.printcontrol` カ
ラムを用意する事で、テンプレートのどのページからPDFを作るか制御できます。

カラム名を `__meta.printcontrol`、カラムの値に LO の印刷ページ指定で使
える文字列を設定します。'1' とすると、テンプレートの1ページ目が、'1-3'
とするとテンプレートの1〜3ページが、'3,5'とすればテンプレートの3ページ
目と5ページ目が一つのPDFファイルに出力されます。

カラム値は「;」で区切って複数の印刷ページ指定を列挙できるので(LOの印刷
範囲指定で使えるのと同じ形式"、

   1; 1; 2,3;

を指定すると、出力のPDFには1ページ目、1ページ目、2,3ページ目の合計4ペー
ジからなるPDFができます。(この場合だとただ "1,1,2,3" と書いても良いで
す)。

テンプレートが1ページだけの場合や、複数ページあるが全ページをPDF化する
ような場合、このカラムを指定する必要はありません。

## テンプレート(Writer文書)の作成

複雑なレイアウトを Writer で適切に表現するのは結構大変ですが、そちらに
ついては Writer のマニュアルなど参照して頑張って下さい。このシステムで
の差し込み処理に必要な部分だけ、説明していきます。

### テキストの差し込み

データのデータフィールド名に対する値を、テンプレート中に差し込みます。

    お名前: XXXXX

の XXXXX の部分を、データフィールド名 `name` の値、山田や鈴木で差し替
えます。

テンプレートのXXXXXの所に、テキストフィールドダイアログからユーザフィー
ルドを追加します。ユーザフィールド名をデータフィールド名、値はテンプレー
ト作成中に確認ができるよう、適当な値を設定して下さい。追加したユーザ
フィールドを、XXXXXに相当する箇所に、ダイアログから「挿入」ボタンを押
して埋め込みます。

同じユーザ変数名に対応するユーザフィールドは、文書中に何箇所でも埋め込
めます。テンプレートの何箇所でも、必要なだけ `name` ユーザフィールドを
配置して下さい。

個々ユーザフィールドごと、まるごとに対してならば、各種の文字装飾など設
定できます。「苗字」と「名前」でフォントを変える必要がある、などの場合、
「苗字」用と「名前」用のデータフィールドを用意して対応して下さい。

注意として、ユーザフィールドを作成する際、書式は「テキスト」を使って下
さい。「テキスト」以外の書式にはシステムが対応していません。データを見
て、使われているユーザフィールドの形式が何か調べて、適切に値を設定する
方法、よくわかりません。

なので、データを作成する際、PDF出力として必要な形式の値を作るようにし
て下さい。`totalprice`データフィールドから、そのままの数字と三桁カンマ
入りの二つの表記を差し込みたいような場合、`totalprice`と
`totalprice_w_comma`のようなデータフィールドを設けて下さい。テンプレー
トでは必要に応じて、ユーザフィールド `totalprice` と
`totalprice_w_comma` を使い分けて下さい。

### 画像の場合

データに対応して画像をいろいろ差し替える場合です。いくつかのパターンが
ありますが、いずれの場合もテンプレート作成の際に、

 - PDF出力したい場所、大きさに画像を置く。画像の中身はなんでも良い
 - 差し込み処理で書き変わる画像は、**画像名** を適切につける

必要があります。画像名はデータフィールド名をもとにして、いくつかのルー
ルから決めます。ルールはこれから説明します。

なお一つの文書中でオブジェクトの名前は一意でなければなりません。画像に
つける名前も同様です。これは差し込みを使って何箇所かに同じ画像を出す必
要がある場合に問題となります。このような場合、画像名を本来付けたい画像
名の後に`,なんちゃら`を付けて、一意になるようにして下さい。

`foo.CODE128` 処理した画像を3箇所に配置したいのであれば、それぞれの画
像名を、`foo.CODE128`、`foo.CODE128,1`、`foo.CODE128,2`とかして下さい。

あと、テンプレート上では画像の中身はダミーでいいんですが、実際使われる
画像と同じフォーマット(SVGとかPNGとか)にしておいた方が良いのかもしれま
せん。画面上ではちゃんとしてるのに、印刷したらきちんと表示されない、場
合がありました。原因がこれかは不明なんですが。

画像用の機能は

 - 画像生成
 - Toggleタイプ
 - Selectionタイプ

の三種類になります。

#### バーコード、QRCode などの画像生成

データフィールド、`shippingcode` の値からバーコードやQRコードを生成し、
テンプレートの指定画像を差し替える事ができます。バーコード、QRコードは
SVGフォーマットで作成されます。
差し替え対象とする画像名は、`データフィールド名.画像生成アルゴリズム`
にします。現時点でサポートされている画像生成アルゴリズムは

 - EAN8 (ex. `shippingcode.EAN8`)
 - EAN13 (ex. `shippingcode.EAN13`)
 - EAN14 (ex. `shippingcode.EAN14`)
 - CODE39 (ex. `shippingcode.CODE39`)
 - CODE128 (ex. `shippingcode.CODE128`)
 - JAN (ex. `shippingcode.JAN`)
 - UPCA (ex. `shippingcode.UPCA`)
 - ISBN13 (ex. `shippingcode.ISBN13`)
 - ISBN10 (ex. `shippingcode.ISBN10`)
 - ISSN (ex. `shippingcode.ISSN`)
 - PZN (ex. `shippingcode.PZN`)
 - ITF (ex. `shippingcode.ITF`)
 - QRCODE (ex. `shippingcode.QRCODE`)

になります。QRCODE以外は、バーコードの形式だそうです(よく知りません)。


    配送コード [|||||||||]

テンプレートに置いた画像 [|||||||||] の部分を右クリックして、プロパティ
の「名前」を、`shippingcode.CODE39`などと変更して下さい。テンプレートで
見える画像の大きさで、実際のPDFに出力されますので、印刷しても読み取り
に問題のない大きさにするようご注意下さい。

ただバーコード程度だと、普通のユーザフィールドを埋め込んで、このフォン
ト種を「バーコードフォント」というやつに変えるだけでも済みます(フォン
トで対応できるものならば)。各バーコード形式用のフォントがあれば、それ
を LibreOffice で使えるようにインストールして、フォントをそれにすれば
良いです。このプログラムはCodabar(NW7) の生成には対応していませんが、
Codabar用フォントを無料で配布している所があるので、それを使えばどうに
かできます。私が使ったものは商用利用も可能ですが再配布は不可でした。


自分で画像生成処理を追加する事もできるでしょう。その場合の生成画像フォー
マットは LibreOffice が対応していて、pythonから生成できるフォーマット
ならなんでも良いでしょう。

#### 切り替え用の画像について

データ(CSV)の作成のところで説明した、Toggle、Selection の方法を説明す
る前に、用意する必要のある画像について説明しておきます。

テンプレートと同じディレクトリに'icons'ディレクトリを作成(コマンド行オ
プションで別のディレクトリの指定も可能)し、その下に切り替え用の画像を
用意する必要があります。サンプルが、samples/icons/ の下にあります。

Toggle では、用意してある指定の「系列」に属する画像から、どれか一つを
差し替え画像として選択して、差し込みを行ないます。Selection は、Toggle
に分解されるので、やはり用意してある「系列」の画像から、0もしくは1用の
画像を選択し、差し込みを行ないます。

系列は、テンプレートの画像名で指定します。系列のどの画像が使われるかは、
データフィールドの値、もしくは 0/1 を使って決められます。系列と値から
どの画像が使われるかは、用意した画像に付いたファイル名で決まります。

「系列」は、例えば「マルバツ」とか、「チェックボックス」とか、「マーク
シート」、「色アイコン」などです。ファイル名やWriterの画像名として使う
ので、英数字だけにしとくのが無難ですが。

値は、Toggleタイプならばのデータフィールドの値として指定するもの、ブー
ル値(オンとオフを表わす)ならば「0」と「1」が画像ファイルとして必要にな
ります。

画像のファイル名を、`系列.値.png` として、iconsの下に置いて下さい。
例えば

 - samples/icons/Check.0.png
 - samples/icons/Check.1.png

は、`Check`系列の`0`と`1`の値に対応する画像です。`Check.0.png`はチェッ
クボックスのチェックなし用、`Check.1.png`はチェックボックスのチェック
あり用を意味しています。`Check`系列には0と1用があるので、Toggle、
Selection どちらでも使えます。

 - samples/icons/Grade.bad.png
 - samples/icons/Grade.good.png
 - samples/icons/Grade.verygood.png

は、`Grade`系列の `bad`、`good`、`verygood`用の画像です。0と1用がない
ので Selection では使えませんが、Toggle で使えます。

マークシートを表現したいのであれば、`marksheet`系列として、
`marksheet.0.png` に ○ の画像、`marksheet.1.png`に ● の画像を icons/
の下に、ファイル名が表わす通りの PNG フォーマットで用意しておきます。
そうすると、テンプレートから `marksheet` 系列が使えるようになります。

という事で。

#### Toggle タイプ

データフィールドの値に対応する、画像系列のどれかから一つでテンプレート
の画像を差し替えます。差し替える画像には、`データフィールド名.系列`と
いう画像名を、画像のプロパティ、名前の項目で設定します。

    □ 以上に同意します

の□を、agreementデータフィールドの値に応じて、`Check`系列の0か1の画像
で差し替える場合、テンプレートの□の画像に、`agreement.Check`という名
前を設定します。データの `agreement.Toggle` カラムの値によって、画像が
差し替えられます。

color データフィールドが赤、青、黒、白を取る場合で、

    色: ○

の○の部分を、`ColorIcon`系列の赤、青、黒、白の値に応じて差し替えるの
であれば、○の画像名を `color.ColorIcon` と設定します。データの
`ColorIcon.Toggle`カラムの値により、`icons/ColorIcon.赤.png` や
`icons/ColorIcon.黒.png` といったファイルの中身が差し替え表示されます。

テンプレートの何箇所かで同じ差し替えを行なう場合、画像名を一意にするた
め、`,1`、`,2`、`,3`…などを画像名に後置したものを画像名として下さい。
画像名のカンマより後の部分は、差し込み処理プログラムでは無視します。

#### Selection タイプ

データフィールドの値に応じて、いくつかの画像を差し替えます。差し替え対
象となる一連の画像名に、`データフィールド名.データフィールド値.系列`を
設定して下さい。

`era`データフィールドが値 M T S H R のいずれかを取り、テンプレートの

    □ 明治  □ 大正 □ 昭和 □ 平成 □ 令和

それぞれの□を、チェックボックス用の`Check`系列の画像で差し替える場合、
`Check`系列の画像として

 - `icons/Check.0.png`
 - `icons/Check.1.png`

を用意しておきます。で、テンプレートのそれぞれの画像(□)を

 - 明治用の□の画像名 `era.M.Check`
 - 大正用の□の画像名 `era.T.Check`
 - 昭和用の□の画像名 `era.S.Check`
 - 平成用の□の画像名 `era.H.Check`
 - 令和用の□の画像名 `era.R.Check`

という名前にします。するとデータのカラム名 `era.Selection` の値に応じ
て、それぞれの□が差し替えられます。

全ての画像は必ず、カラムで指定されたもので差し替えられます。入力データ
に対応するカラムがない場合、テンプレートの画像はそのままになります。


テンプレートとデータの作成については、以上。

samples/ 以下に、テスト用も含めてサンプルがあるので、実際に処理してで
きた PDF を眺めてみて下さい。説明が書いてあるサンプルもあります。

[実行プログラムについて](./03_about_script.md)
