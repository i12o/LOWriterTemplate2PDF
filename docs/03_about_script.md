# 実行プログラムについて

`bin/generic_form_insertion.py` は余計な処理を行なわない、汎用の差し込
み処理を行なうプログラムです。差し込みに使うデータを作成する段階で必要
なデータを全てそろえておけるのであれば、これで十分使えると思います。

入力データを処理する際に、データ変換処理が必要だったり、出力ファイル名
を特定カラムの値を使ったものにするなどの変更を行ないたい場合、上スクリ
プトをカスタマイズして、必要なコードを追加して下さい。カスタマイズの一
例が `bin/hagaki_atena_sasikomi.py` です。

レポジトリの内容をチェックアウトしたままの、プロジェクトディレクトリ階
層構造で動かす事を想定しています。別の場所で動かす場合、適切にスクリプ
トのモジュールパスなど書き換えて下さい。

## generic_form_insertion.py について

    bin/generic_form_insertion.py [オプション] CSVファイル

`-t` オプションで指定したodtファイルをテンプレートとし、CSVファイルを
差し込みデータとし、PDFの生成を行ないます。`-h`オプションを指定して実
行すると、指定可能なオプションの説明が出ます。

### -h or --help

簡単な説明を表示します。

### -t or --odt ODTファイル名

テンプレートとなる odt ファイルを指定します。省略時は、現在アクティブ
な Writer 文書がテンプレートとして使われます。テンプレートを作成してい
る最中の確認などに使えますが、ユーザ変数や画像など差し替えられますので、
事前にセーブしておいてから実行するなど注意して下さい(スクリプトから書
き換えられた場合、アンドゥが効きません)。

### -v or --verbose

実行時のログレベルを上げます。重ねて書くとよりレベルが上がります。
ex. `-vv`

### -q or --quiet

ログレベルを下げます。エラー以外表示されなくなるはずです。

### --icons-path ディレクトリ

Toggle、Selection で使われる画像を保存してあるディレクトリを指定します。
デフォルトはテンプレートファイルのあるディレクトリにある `icons/` が使
われます。

### --pdf-export ディレクトリ

PDFを出力するディレクトリを指定します。デフォルトはプロジェクトトップ
の `pdfout/` になります。このディレクトリの下にデータの1レコード目から
順に、`0001.pdf`、`0002.pdf`、`0003.pdf`…が作成されます。

### --loport UNO-URL

LibreOffice 起動時に `--accept` に指定した UNO-URL を渡します。省略時
デフォルトは `socket,host=localhost,port=2083;urp;` となっています。

### --printout

差し込み処理を行なった後、LibreOffice から直接プリンターに印刷します。
このオプションが指定されると、PDFの作成は行なわれません。PDFとして出力
されるはずだったものが、そのままプリンターに送られます。

### --printer-name プリンタ名

特定のプリンタで印刷したい場合、`--printout` と一緒に指定してプリンタ
名を指示します。プリンタ名は LibreOffice でプリンターの設定ダイアログ
を開いた際に、選択肢として表示されている名前を指定します。

十分なテストを行なっていないため、不具合があるかもしれません。紙とイン
クを無駄遣いしないよう、本番データを差し込む前に1レコードだけのデータ
を差し込んでみて、ちゃんと意図したプリンタから正常に印刷されるか確認し
て下さい。

### --experimental-spillfix 1 or 2

差し込みテキストが「枠」からはみ出さないよう、フォントサイズ小さくして
調整する機能を有効にします。「枠」は Writer の「枠(TextFrame)」で、テー
ブルのセルやフォームのテキストボックスなどでは使えません。

はみ出し調整対象とする TextFrameには、そのフレームオブジェクトの「説明」
のところに `spillfix` という文字列を埋め込んでおく必要があります。説明
に`spillfix`と書かれた枠だけが調整対象となります。それ以外の枠ははみ出
しがあってもそのままです。

処理としては、TextFrame内の段落それぞれの文字全ての大きさを一律に縮小
してみて、はみ出さなくなったか確認します。これをフォントサイズが5pt(フ
レームの「説明」に入れる文字で最少サイズを指定可能)になるまで試します。

現在の実装では一度調整が行なわれた枠では、内部の文字サイズ指定が一律に
変化してしまい、これを完全には元の状態に戻せません。文字単位で指定され
ているフォントサイズが無効になってしまいます。またはみ出しているかどう
かの判定が場当たり的なものなので、本当にはみ出さないようにできているか、
確実ではありません。よってこの機能は実験的なものと考えて下さい。

オプションパラメータは1か2を指定します。2を指定した場合、調整しきれな
かった場合該当データレコードのPDFを生成せず、警告を出します。1の場合、
はみ出しが調整しきれなかった場合も、フォントを最少にした状態で PDF を
生成します。

TextFrameオブジェクトの説明に spillfix:FLOAT と書いておくと、FLOATで指
定したサイズが最少のフォントサイズ(pt)になります。省略時は 5pt が下限
となっています。

`samples/test_experimental_spillfix.odt` がこの動作の確認用サンプルに
なっていますので、興味があればこのファイルをご覧下さい。

## カスタマイズ(Pythonコード書ける方向け説明)

ファイル名の生成方法と、読み込みデータに対する変換処理を、処理モジュー
ルに渡せるようになっています。`InsertionProcess.InsertionProcess`オブ
ジェクト生成時に、コンストラクタに filenamer、data_converter オプショ
ンを指定します。

### filenamer 引数

ファイル名を生成して返す関数を指定します。

    FUNCTION(レコード番号:int,レコード:dict,オブジェクト) -> str:

となる関数を指定して下さい。レコードは処理中の1レコード、CSVの1行です。
レコード番号はCSVの何行目を処理しているかを示します。オブジェクトは
`InsertionProcess.InsertionProcess` のインスタンスが渡されます。

次のような関数

    def by_primarykey(num, record, obj):
       return record['PrimaryKey'] + '.pdf'


を filenamer に指定すると、入力データの `PrimaryKey` の値に `.pdf` を
付けたものが PDF の名前になります。

### data_converter

1レコードを受けて、そのレコード自体を破壊的に書き換える関数のリストを
渡して下さい。

    FUNCTION1(レコード番号:int,レコード:dict,オブジェクト) -> Bool
    FUNCTION2(レコード番号:int,レコード:dict,オブジェクト) -> Bool
    FUNCTION3(レコード番号:int,レコード:dict,オブジェクト) -> Bool
    ...

    data_conveter=[ FUNCTION1, FUNCTION2, FUNCTION... ]


それぞれの関数では、引数で渡されたレコード自体の書き換えを行なって下さ
い。レコードは dict 型です。

一連の関数のどれかから False が返された場合、データ変換はその場で停止
し、PDF出力がスキップされます。特定条件に一致した場合レコードからPDFに
はしないような処理は、条件を調べて False を返す関数として実装できます。

### カスタマイズ例

`bin/hagaki_atena_sasikomi.py` は filenamer と data_converter を使った
カスタムスクリプトです。

 - Zip1、Zip2、SZip1、SZip2 を一文字づつに分解する `zip`
 - 苗字、名前が一文字の場合に、両端揃えがみっともなくならないよう、前
   後に空白を追加する `one_char_name`
 - 一枚のハガキに書く宛名の数、苗字指定により、3ページからなるテンプレー
   トのどのページを使うか決定する `select_one_Style`

の3つの`data_converter`を追加しています。

`filenamer`、普通のと同じですが、こんな具合に書く、というサンプルです。

[ユーティリティ](./04_utils.md)
