# 実行プログラムについて

`bin/generic_form_insertion.py` は余計な処理を行なわない、汎用の差し込
み処理を行なうプログラムです。差し込みに使うデータを作成する段階で必要
なデータを全てそろえておけるのであれば、これで十分使えると思います。

入力データを処理する際に、データ変換処理が必要だったり、出力ファイル名
を特定カラムの値を使ったものにするなどの変更を行ないたい場合、上スクリ
プトをカスタマイズして、必要なコードを追加して下さい。カスタマイズの一
例が `bin/hagaki_atena_sasikomi.py` です。

レポジトリの内容をチェックアウトしたままの、プロジェクトディレクトリ階
層構造で動かす事を想定しています。別の場所で動かす場合、適切にスクリプ
トのモジュールパスなど書き換えて下さい。

## generic_form_insertion.py について

    generic_form_insertion.py [オプション] CSVファイル

`-t` オプションで指定したodtファイルをテンプレートとし、CSVファイルを
差し込みデータとし、PDFの生成を行ないます。`-h`オプションを指定して実
行すると、指定可能なオプションの説明が出ます。

### -h or --help

簡単な説明を表示します。

### -t or --odt

テンプレートとなる odt ファイルを指定します。省略時は、現在アクティブ
な Writer 文書がテンプレートとして使われます。テンプレートを作成してい
る最中の確認などに使えますが、ユーザ変数や画像など差し替えられますので、
事前にセーブしておいてから実行するなど注意して下さい(スクリプトから書
き換えられた場合、アンドゥが効きません)。

### -v or --verbose

実行時のログレベルを上げます。重ねて書くとよりレベルが上がります。
ex. `-vv`

### -q or --quiet

ログレベルを下げます。エラー以外表示されなくなるはずです。

### --icons-path

Toggle、Selection で使われる画像を保存してあるディレクトリを指定します。
デフォルトはテンプレートファイルのあるディレクトリにある `icons/` が使
われます。

### --pdf-export

PDFを出力するディレクトリを指定します。デフォルトはプロジェクトトップ
の `pdfout/` になります。このディレクトリの下にデータの1レコード目から
順に、`0001.pdf`、`0002.pdf`、`0003.pdf`…が作成されます(データに印刷
ページ指定がない限り)。

### --loport

LibreOffice 起動時に `--accept` に指定した UNO-URL を渡します。省略時
デフォルトは `socket,host=localhost,port=2083;urp;` となっています。

### --experimental-spillfix 1 or 2

差し込みテキストが「枠」からはみ出さないよう、フォントサイズ小さくして
調整する機能を有効にします。「枠」は Writer の「枠(TextFrame)」で、テー
ブルのセルなどには働きません。

また、はみ出し調整を行なわせる TextFrameには、そのフレームオブジェクト
の「説明」のところに `spillfix` という文字列を埋め込んでおく必要があり
ます。

TextFrame内の段落それぞれに属する文字全ての大きさを一律に縮小してみて、
はみ出さなくなったか確認します。これをフォントサイズが5pt(フレームの説
明で最少サイズを指定可能)になるまで試します。

フレーム内の文字サイズ指定が一律に変化してしまい、これを完全には元の状
態に戻せないため、調整対象のフレームに含まれる段落内での部分的な文字サ
イズ調整が無効になってしまいます。またはみ出しているかどうかの判定が場
当たり的なものなので、本当にはみ出さないようにできているか、確実ではあ
りません。よってこの機能は実験的なものと考えて下さい。

オプションには1か2を指定します。2を指定した場合、調整しきれなかった場
合該当データレコードのPDFを生成せず、警告を出します。1の場合、はみ出し
が調整しきれなかった場合も、フォントを最少にした状態で PDF を生成しま
す。

TextFrameオブジェクトの説明に spillfix:FLOAT と書いておくと、FLOATで指
定したサイズが最少のフォントサイズ(pt)になります。省略時は 5pt が下限
となっています。

`samples/test_experimental_spillfix.odt` がこの動作の確認用サンプルに
なっていますので、興味があればこのファイルをご覧下さい。

## カスタマイズ(Pythonコード書ける方向け説明)

ファイル名の生成方法と、読み込みデータに対する変換処理を、処理モジュー
ルに渡せるようになっています。`InsertionProcess.InsertionProcess`オブ
ジェクト生成時に、コンストラクタに filenamer、data_converter オプショ
ンを指定します。

### filenamer 引数

ファイル名を生成して返す関数を指定します。

    def FUNCTION(レコード番号,レコード,オブジェクト):
        return 文字列

となる関数を指定して下さい。レコードは処理中の1レコード、CSVの1行です。
レコード番号はCSVの何行目を処理しているかを示します。オブジェクトは
`InsertionProcess.InsertionProcess` のインスタンスが渡されます。

    def by_primarykey(num, record, obj):
       return record['PrimaryKey'] + '.pdf'


を filenamer に指定すると、入力データの `PrimaryKey` の値に `.pdf` を
付けたものが PDF の名前になります。

### data_converter

1レコードを受けて、そのレコード自体を破壊的に書き換える関数のリスト(タ
プルでも良い)を渡して下さい。

    def FUNCTION(レコード番号,レコード,オブジェクト):
        return ブール値

    data_conveter=[ FUNCTION1, FUNCTION2, FUNCTION... ]

関数内では、引数で渡されたレコード自体の書き換えを行なって下さい。レコー
ドは dict 型です。

一連の関数のどれかから False が返された場合、データ変換はその場で停止
し、PDF出力がスキップされます。特定条件に一致した場合レコードからPDFに
はしないような処理は、条件を調べて False を返す関数として実装できます。

### カスタマイズ例

`bin/hagaki_atena_sasikomi.py` は filenamer と data_converter を使った
カスタムスクリプトです。

 - Zip1、Zip2、SZip1、SZip2 を一文字づつに分解する `zip`
 - 苗字、名前が一文字の場合に、両端揃えがみっともなくならないよう、前
   後に空白を追加する `one_char_name`
 - 一枚のハガキに書く宛名の数、苗字指定により、3ページからなるテンプレー
   トのどのページを使うか決定する `select_one_Style`

の3つの`data_converter`を追加しています。

`filenamer` に、出力ファイル名に`_01`とかつけないでレコード番号だけの
ファイル名をつける `filenamer` 関数を追加しています。

[ユーティリティ](./04_utils.md)
