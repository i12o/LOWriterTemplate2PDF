# LOWriterTemplate2PDF

## 何をするものか

LibreOffice Writer(以後 Writer)で作成したテンプレート文書に対して、CSV
などで与えるデータを差し込み、データの1レコード毎のPDFを出力します。帳
票生成、ハガキの宛て名書きなどに使えます。

LibreOffice をサーバプロセスの様に使い、スクリプトからデータの差し込み
と出力を行なうので、バッチとしても使えます。Linux上でしか動作確認をし
ていませんが、LibreOffice、Python3、UNO が使える環境であれば動かせると
思います。

## TL;DR

とりあえず、`bin/generic_form_insertion.py` がメインスクリプトで、
`-t` オプションでテンプレートodtファイルを、その後に CSV ファイルを指
定します。

スクリプトが動作するためには、スクリプトから接続できる LibreOffice が
実行中である必要があります。

    libreoffice --accept='socket,host=localhost,port=2083;urp;'

などとして、事前に LibreOffice を起動しておきます。LibreOffice 起動時
に `--accept` オプションを付ける必要があります。よくわからん、という方
は上の例の通りに実行して下さい。既に起動中の LibreOffice がある場合、
それを一旦終了させてから、上のコマンドで再起動して下さい。これは
localhost のポート 2083 で接続を受け付けるという意味ですが、必要とあれ
ば各自の環境にあわせて変更できます。

    bin/generic_form_insertion.py -t samples/test_sasikomi.odt \
       samples/test_sasikomi.csv

    bin/generic_form_insertion.py -t samples/test_toggle_selection.odt \
       samples/test_toggle_selection.csv

それぞれ、pdfout の下に PDF が作成されるので、データの差し込みが行なわ
れてPDFになってることをご確認下さい。acceptソケットのポート番号などを
変えた場合、スクリプトのオプションで
 `--loport socket,host=localhost,port=2083;urp;`
などを指定できます。

`generic_form_insertion.py` を年賀状の宛名印刷に特化させたのが
`bin/hagaki_atena_sasikomi.py` で、差し込みデータに対する特殊処理が追
加されています。年賀状宛名面のテンプレートも用意してあるので、

    bin/hagaki_atena_sasikomi.py \
       -t samples/nenga_hagaki_multi_pattern.odt \
       samples/nenga_address_sample.csv

して pdfout の下の PDF をご確認下さい。宛名の数(最大3名まで)によってテ
ンプレートから使用されるページが変わるようになっています。こういう宛名
の書き方が適切なものかどうかはよう知りません。こういう事できるよ、とい
うサンプルを兼ねています。普通の年賀ハガキに印刷して使えるよう、位置合
わせはしたつもりです。

## 動作要件、依存

  - Python3
  - LibreOffice(6.1.5 で開発)
  - python3-uno
  - python3-barcode
  - python3-pyqrcode
  - python3-pandas

LibreOffice や Python3、モジュールのバージョンによる依存性は調べていま
せん。多分バージョンに依存するような事はやっていないつもりです。

## 何ができるのか

テンプレート文書(Writerのテンプレートとは違います、このシステムで使う
用に作成する文書です、以後テンプレート)と、CSVデータを用意して、CSVデー
タの一行一行の値を文書に差し込み、PDFを一行につき1ファイル、作成します。

 - テキストの差し込み
 - 画像の差し替え
   - データの値からバーコードやQRコード画像を自動生成し、差し替える
   - データの値から、事前に用意してある画像の対応するものに差し替える
 - 複数ページからなるテンプレート文書を使ったレイアウト切り替え出力
 - 完全ではありませんが、「枠」からはみ出さないよう、差し込みテキスト
   の文字サイズを変える機能が実装されています。いろいろ指定が必要です。

テキストを差し込む部分には、Writerの「フィールド」を配置します。テンプ
レートの「フィールド」に対しては、フォントサイズ、ボールド、下線などの
装飾をつけられます。

画像を差し替える部分は、テンプレートに置き換えたい画像を配置しておき、
画像に「名前」(画像名)を付けます。画像はPDFで出力したい大きさ、場所に
配置しておきます。「名前」に対応するデータの列を使って、生成した画像や
準備してある画像による差し替えが行なわれます。

チェックマークのチェックあり・なし、スタンプ的な画像から選択したものを
表示する場合に使える機能があります(このツールではToggleと呼びます)。ま
たラジオボタン的に、データの一つの値から複数のマークを連動して差し替え
るための機能もあります(このツールでは、Selctionと呼びます)。

複数ページからなるテンプレートを用意し、入力データからどれかのページの
みPDFにするようにもできます。1ページ目に着払い用、2ページ目には前払い
用、と複数ページからなる配達伝票テンプレートを用意し、差し込みデータで
どっちのページをPDFにするか指定できます。一つの入力データと一つのテン
プレートファイルから、複数種類のレイアウト出力を作成できます。

Writerで複雑な帳票レイアウトを作る作業に耐えられるなら、結構色々できる
んじゃないでしょうか。

## 制作動機

Linux で帳票を、バッチで作成できるようにするためです。

Writer を帳票テンプレートの作成ツール兼レンダラーとして使うので、ある
程度品質の良い帳票が生成できます。差し込まれるデータに対して凝った装飾
を行なえはしませんが、差し込まれるデータ毎にフォント、文字装飾などは指
定できます。

バーコードやQRCodeの生成、テンプレート文書中の画像の差し替えができるの
で、ある程度複雑な帳票の作成にも対応できます。

出力されるPDFの見た目は Writer を使って制御するので、テンプレート文書
作成者が見た目をコントロールします。差し込まれるデータは名前つきのRDB
のテーブルのようなデータであり、生成される帳票のレイアウトにはあまり依
存しません。とりあえずタブ切りの CSV を読み込みますので、データ作成は
様々な方法で行なえます。帳票レイアウトを用意するのと、データ作成を別々
の人が担当できるよう、このような形になっています。

WriterもMS-Wordもほぼ使ったことなかったこともあり、Writerで複雑なレイ
アウトの帳票を作成するのは多少は慣れた今でも大変ではありますが、Writer
の機能を上手く使えばそこそこのものが作れるでしょう。

これまでは Calc、Base と連携させて年賀状の宛名印刷をする方法をやってま
したが、年一度しか使わないのでBaseの使い方とかCalcのデータを用意する際
の作法とか忘れてしまい年末に毎回頭捻ってました。テンプレートは余程の事
がなければいじる必要ありませんので、今後はただのCSVを出すだけですむよ
うになり、次の年末は楽できそう。

[テンプレート文書と差し込みデータの作り方](./02_writing_template_and_data.md)
